---
name: setup
layout: default
permalink: /lore/end_users/setup/
---

# Setup

## Table of Contents

* [Robots](#robots)
* [Webhook](#webhook)
* [Hoist Configuration](#hoist-configuration)
  * [Zuul Job Configuration](#zuul-job-configuration)
  * [Zuul Layout Configuration](#zuul-layour-configuration)
* [Project Test Configuration](#project-test-configuration)
* [Merge Options](#merge-options)
  * [Setting the Correct Merge Option](#setting-the-correct-merge-option)

## Give BonnyCI Access

The first step to getting BonnyCI into your repository is to give `anne-bonny`
write access. This is so BonnyCI can set statuses and automatically merge pull
requests that pass all testing queues. We recommend creating a `robots` team in
your repository's owning org, but you can also just add `anne-bonny` directly as
a collaborator.

### Robots team

If you want to create a team to hold `anne-bonny` in, Navigate to your
repository's settings page, click on the `Collaborators & teams` section
in the left-hand menu, and click `+ Create a team`. You will be added
to the team automatically. Type `anne-bonny` into the `Add a person`
box. This will invite anne-bonny to the team, you will need to wait
for an admin to accept that invitation before BonnyCI will be able to
interact with your repository.

### Grant Write Access

Navigate back to your repository settings, `Collaborators & teams`. If you
created a team, click the `Add a team:` dropdown menu under the `Teams`
section. Find your robots team there. Then select 'Write' access so the
team can write to your repository. If you want to just add `anne-bonny`
directly as a collaborator, you can do that as well. Simply add the user
with Write access. As with team membership, you will need to wait for
an admin to accept the invitation, which we will do as part of merging
your configuration layout.

For more on organizations and teams, check out the [Github documentation](https://help.github.com/enterprise/2.8/admin/guides/user-management/organizations-and-teams/).

## Webhook

The next step to getting BonnyCI into your repository is to add the BonnyCI webhook. This is to notify BonnyCI of events taking place in your repository, such as newly opened pull requests. Navigate to your repository's settings page, click on the `Webhooks` section in the left-hand menu, and click the `Add webhook` button to the right. Paste the following link into the `Payload URL` item:

```webhook
https://zuul.bonnyci.org/connection/github/payload
```

Ensure the `Content Type` dropdown is set to `application/json`, the `Send me everything.` radio button is selected, and the `Active` box is checked. Once this is done, click the green `Add webhook` button to finish. Here is a sample of what the settings will look like:

![Correct Webhook Configuration](../../misc/images/BonnyCIWebhook.png)

## Hoist Configuration

We'll need some configuration changes in [hoist](https://github.com/BonnyCI/hoist) for your project to gain the necessary Zuul testing queues. Follow our [contribution lore](https://github.com/BonnyCI/lore/tree/master/developers/contributing) for getting these files updated.

### Zuul Layout Configuration

We need to add your project to the list of projects that will be sending webhook events to BonnyCI. Edit `hoist/roles/zuul/templates/etc/zuul/config/layout.yaml` and add an entry in the `projects:` list for your project. Ensure it is in alphabetical order. Here is a sample configuration:

```YAML
projects:
  ...

  - name: unique_job_name
    check_github:
      - bonnyci-run-check
    gate_github:
      - bonnyci-run-gate

  ...
```

Create a pull request to the [hoist](https://github.com/BonnyCI/hoist) project on Github that contains this change.  A BonnyCI administrator will review the change and merge it into the production BonnyCI configuration.

## Project Test Configuration

Projects are free to define their tests and test suites within their repository provided it contains a known entry point for BonnyCI to use to begin the execution.  When BonnyCI begins a test run, it will first prepare a checkout of the git repository that contains the proposed change.  It will then attempt to execute a script located at ``./bonnyci/run.sh`` and consider a exit code of ``0`` as a successful test and anything other than ``0`` as a failed test.  If the repository does not contain ``./bonnyci/run.sh`` or it is not executable, the test run will fail. Users are free to customize ``./bonnyci/run.sh`` in any way they choose.

This script is run to execute tests in both the check and gate pipelines.  If you'd like to differentiate the test runs between the different pipelines, check the setting of the ``BONNYCI_TEST_PIPELINE`` variable, which will be set to ``check`` or ``gate``, respsectively.

By default, the console output of all test runs is collected and archived for viewing after the test run has completed.  If there are additional log files generated by your tests that you would like to also archive, your ``.bonnyci/run.sh`` script may copy them into a known location and they will be archived as well.  This directory will be specified in the ``BONNYCI_TEST_LOG_DIR`` environment variable.  The console log and any additional logs stored in this directory are archived regardless of the result of the test run itself.

Check out an example .bonnyci/run.sh script [here](examples/example_bonnyci_run.md).

## Merge Options

Repositories that use BonnyCI should not use any merge strategy which changes the SHA of the commit. This is because [zuul](https://github.com/openstack-infra/zuul), the scheduler used in BonnyCI, will be thrown off by the change in SHA if multiple changes are running in the gate. BonnyCI tests the changes in the pull requests without altering them. To ensure that which is tested is what is merged, do not enable a merge strategy that would alter the pull request content upon merging it.

GitHub presents repository owners with 3 choices for what happens when merging a pull request:

* Create a merge commit
* Squash and merge
* Rebase and merge

For more on these options and what they mean, read the [documentation on merge methods](https://help.github.com/articles/about-merge-methods-on-github/) provided by GitHub.

### Setting the Correct Merge Option

In order for BonnyCI to function correctly, please only allow merge commits. From your repository's home page, navigate to the `Settings` tab. Scroll down to the section labeled `Merge button`, and ensure that it matches the following:

![Correct Merge Button Configuration](../../misc/images/mergebutton.png)
