---
name: setup
layout: default
permalink: /lore/end_users/setup/
---

# Setup

## Table of Contents

* [Installation](#installation)
* [Hoist Configuration](#hoist-configuration)
  * [Zuul Job Configuration](#zuul-job-configuration)
  * [Zuul Layout Configuration](#zuul-layour-configuration)
* [Project Test Configuration](#project-test-configuration)
* [Merge Options](#merge-options)
* [Branch Protections](#branch-protections)
  * [Setting the Correct Merge Option](#setting-the-correct-merge-option)
  * [Removing restrictions on who can push](#removing restrictions on who can push)

## Installation

BonnyCI makes use of GitHub's [integration feature](https://developer.github.com/early-access/integrations/).
To install it go to the [BonnyCI integration configuration page](https://github.com/integration/bonnyci) and press the "Install" button.
An integration is installed to your user or your organization. You can then select whether to make it available to all repositories or only selected ones.

You may notice here that BonnyCI requests write access to these repositories. This is required for BonnyCI to be able to merge pull requests on your repositories.

## Hoist Configuration

We'll need some configuration changes in [hoist](https://github.com/BonnyCI/hoist) for your project to gain the necessary Zuul testing queues. Follow our [contribution lore](https://github.com/BonnyCI/lore/tree/master/developers/contributing) for getting these files updated.

### Zuul Layout Configuration

We need to add your project to the list of projects that will be sending webhook events to BonnyCI. Edit `hoist/roles/zuul/templates/etc/zuul/config/layout.yaml` and add an entry in the `projects:` list for your project. Ensure it is in alphabetical order. Here is a sample configuration:

```YAML
projects:
  ...

  - name: unique_job_name
    check_github:
      - bonnyci-run-check
    gate_github:
      - bonnyci-run-gate

  ...
```

Create a pull request to the [hoist](https://github.com/BonnyCI/hoist) project on Github that contains this change.  A BonnyCI administrator will review the change and merge it into the production BonnyCI configuration.

## Project Test Configuration

Projects are free to define their tests and test suites within their
repository provided it contains a known entry point for BonnyCI
to use to begin the execution.  When BonnyCI begins a test run, it
will first prepare a checkout of the git repository that contains the
proposed change.  It will then attempt to execute a script located at
``.bonnyci/run.sh`` and consider a exit code of ``0`` as a successful
test and anything other than ``0`` as a failed test.  If the repository
does not contain ``.bonnyci/run.sh`` or it is not executable, the test
run will fail. Users are free to customize ``.bonnyci/run.sh`` in any
way they choose.

This script is run to execute tests in both the check and gate pipelines.  If you'd like to differentiate the test runs between the different pipelines, check the setting of the ``BONNYCI_TEST_PIPELINE`` variable, which will be set to ``check`` or ``gate``, respsectively.

By default, the console output of all test runs is collected and archived for viewing after the test run has completed.  If there are additional log files generated by your tests that you would like to also archive, your ``.bonnyci/run.sh`` script may copy them into a known location and they will be archived as well.  This directory will be specified in the ``BONNYCI_TEST_LOG_DIR`` environment variable.  The console log and any additional logs stored in this directory are archived regardless of the result of the test run itself.

Check out an example .bonnyci/run.sh script [here](examples/example_bonnyci_run.md).

## Merge Options

Repositories that use BonnyCI should not use any merge strategy which changes the SHA of the commit. This is because [zuul](https://github.com/openstack-infra/zuul), the scheduler used in BonnyCI, will be thrown off by the change in SHA if multiple changes are running in the gate. BonnyCI tests the changes in the pull requests without altering them. To ensure that which is tested is what is merged, do not enable a merge strategy that would alter the pull request content upon merging it.

GitHub presents repository owners with 3 choices for what happens when merging a pull request:

* Create a merge commit
* Squash and merge
* Rebase and merge

For more on these options and what they mean, read the [documentation on merge methods](https://help.github.com/articles/about-merge-methods-on-github/) provided by GitHub.

### Setting the Correct Merge Option

In order for BonnyCI to function correctly, please only allow merge commits. From your repository's home page, navigate to the `Settings` tab. Scroll down to the section labeled `Merge button`, and ensure that it matches the following:

![Correct Merge Button Configuration](../../misc/images/mergebutton.png)

## Branch Protections

Some branch protections will not interact well with BonnyCI, and some are fine.

### Require branches to be up to date before merging

This protection is particularly problematic, as BonnyCI will be merging
code and ensuring that the latest commits are tested with the tip
of master. If this is turned on, you will see spurious merge failure
comments from BonnyCI in approved PR's.

### Removing restrictions on who can push

This protection adds an extra layer of permissions to further limit who is
allowed to push to a given branch of the repository. Unfortunately it is not
possible to explicitly grant the BonnyCI bot extra rights with this option. If
this option is used, it will prevent BonnyCI from being able to merge changes.
